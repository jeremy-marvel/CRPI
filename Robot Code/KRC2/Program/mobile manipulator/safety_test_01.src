&ACCESS RVP
&REL 80
&PARAM TEMPLATE = C:\KRC\Roboter\Template\vorgabe
&PARAM EDITMASK = *
DEF safety_test_01( )

DECL INT COUNT
DECL INT MODE
DECL INT POSITION
DECL BOOL PREEMPT
DECL BOOL SICK_TEST
DECL BOOL STOP_TEST
DECL BOOL MOVING

;FOLD INI
  ;FOLD BASISTECH INI
    GLOBAL INTERRUPT DECL 3 WHEN $STOPMESS==TRUE DO IR_STOPM ( )
    INTERRUPT ON 3 
    BAS (#INITMOV,0 )
  ;ENDFOLD (BASISTECH INI)
  ;FOLD USER INI
    ;Make your modifications here

  ;ENDFOLD (USER INI)
;ENDFOLD (INI)

; Start motions at the hover point
;FOLD PTP GBB_hover Vel=100 % PDAT1 Tool[4]:Pneumatic_gripper Base[0];%{PE}%R 5.6.11,%MKUKATPBASIS,%CMOVE,%VPTP,%P 1:PTP, 2:GBB_hover, 3:, 5:100, 7:PDAT1
$BWDSTART=FALSE
PDAT_ACT=PPDAT1
FDAT_ACT=FGBB_hover
BAS(#PTP_PARAMS,100)
PTP XGBB_hover 
;ENDFOLD

MOVING=true
MODE = 4
POSITION = 1
PREEMPT = true
SICK_TEST = FALSE
STOP_TEST = FALSE

SWITCH MODE
  CASE 0
   ; SToP TeSt
   STOP_TEST = TRUE
   
  CASE 1
    ; Safety rated monitored stop
    OVERRIDE_SPEED = TRUE
    MOVE_PERMISSION = FALSE
  CASE 2
    ; Give permission for robot to move
    MOVE_PERMISSION = TRUE
    OVERRIDE_SPEED = FALSE
  CASE 3 
    ; test 1
    MOVE_PERMISSION = FALSE
    OVERRIDE_SPEED = FALSe
  CASE 4
    ; full test
    OVERRIDE_SPEED = TRUE
    MOVE_PERMISSION = true
ENDSWITCH



; Move to button
;FOLD LIN GBB Vel=0.5 m/s CPDAT4 Tool[4]:Pneumatic_gripper Base[0];%{PE}%R 5.6.11,%MKUKATPBASIS,%CMOVE,%VLIN,%P 1:LIN, 2:GBB, 3:, 5:0.5, 7:CPDAT4
$BWDSTART=FALSE
LDAT_ACT=LCPDAT4
FDAT_ACT=FGBB
BAS(#CP_PARAMS,0.5)
LIN XGBB 
;ENDFOLD

HALT

;FOLD WAIT Time=15 sec;%{PE}%R 5.6.11,%MKUKATPBASIS,%CWAIT,%VWAIT,%P 2:15
WAIT SEC 15
;ENDFOLD

; 2 stow request
; 3 robot can move
; 4 agv stopped
; 5 agv stopped verify
; 6 sick signal

IF SICK_TEST THEN
  WHILE TRUE  
    IF $IN[6] THEN
      $OUT[1] = FALSE
    ELSE
      $OUT[1] = TRUE
    ENDIF
  ENDWHILE
ELSE
  IF MOVE_PERMISSION OR STOP_TEST THEN
;    $OUT[1] = TRUE
    IF MOVE_PERMISSION THEN
      ; Permission to move
      WAIT FOR ($IN[3])
    ENDIF
    ; Verification is safe to move
    WAIT FOR ($IN[4] and not $IN[5])

;    WAIT FOR ($IN[4])
  ENDIF

  ;FOLD PTP GBB_hover Vel=100 % PDAT15 Tool[4]:Pneumatic_gripper Base[0];%{PE}%R 5.6.11,%MKUKATPBASIS,%CMOVE,%VPTP,%P 1:PTP, 2:GBB_hover, 3:, 5:100, 7:PDAT15
$BWDSTART=FALSE
PDAT_ACT=PPDAT15
FDAT_ACT=FGBB_hover
BAS(#PTP_PARAMS,100)
PTP XGBB_hover 
;ENDFOLD

;  HALT

  FOR COUNT = 1 TO 80
    ; Allow AGV to preempt motion
    IF (PREEMPT AND MOVE_PERMISSION) OR (STOP_TEST AND $IN[5]) THEN
      IF $IN[2] OR (STOP_TEST AND $IN[5]) THEN
;        PTP GBB_HOVER C_PTP

        ;FOLD PTP GBB_hover Vel=100 % PDAT16 Tool[4]:Pneumatic_gripper Base[0];%{PE}%R 5.6.11,%MKUKATPBASIS,%CMOVE,%VPTP,%P 1:PTP, 2:GBB_hover, 3:, 5:100, 7:PDAT16
$BWDSTART=FALSE
PDAT_ACT=PPDAT16
FDAT_ACT=FGBB_hover
BAS(#PTP_PARAMS,100)
PTP XGBB_hover 
;ENDFOLD
;        LIN GBB

        ;FOLD LIN GBB Vel=0.5 m/s CPDAT5 Tool[4]:Pneumatic_gripper Base[0];%{PE}%R 5.6.11,%MKUKATPBASIS,%CMOVE,%VLIN,%P 1:LIN, 2:GBB, 3:, 5:0.5, 7:CPDAT5
$BWDSTART=FALSE
LDAT_ACT=LCPDAT5
FDAT_ACT=FGBB
BAS(#CP_PARAMS,0.5)
LIN XGBB 
;ENDFOLD
        IF MOVE_PERMISSION THEN
          WAIT FOR ((NOT $IN[2]) and ($IN[3]))
        ELSE
          WAIT FOR ($IN[4] AND NOT $IN[5])
        ENDIF
      ENDIF
    ENDIF

    IF MOVING THEN
      SWITCH POSITION
      CASE 1
        ;FOLD PTP pt1 CONT Vel=50 % PDAT10 Tool[4]:Pneumatic_gripper Base[0];%{PE}%R 5.6.11,%MKUKATPBASIS,%CMOVE,%VPTP,%P 1:PTP, 2:pt1, 3:C_PTP, 5:50, 7:PDAT10
$BWDSTART=FALSE
PDAT_ACT=PPDAT10
FDAT_ACT=Fpt1
BAS(#PTP_PARAMS,50)
PTP Xpt1 C_PTP
;ENDFOLD
        POSITION = 2
      CASE 2
        ;FOLD PTP pt2 CONT Vel=50 % PDAT11 Tool[4]:Pneumatic_gripper Base[0];%{PE}%R 5.6.11,%MKUKATPBASIS,%CMOVE,%VPTP,%P 1:PTP, 2:pt2, 3:C_PTP, 5:50, 7:PDAT11
$BWDSTART=FALSE
PDAT_ACT=PPDAT11
FDAT_ACT=Fpt2
BAS(#PTP_PARAMS,50)
PTP Xpt2 C_PTP
;ENDFOLD
        POSITION = 3
      CASE 3
        ;FOLD PTP pt3 CONT Vel=50 % PDAT12 Tool[4]:Pneumatic_gripper Base[0];%{PE}%R 5.6.11,%MKUKATPBASIS,%CMOVE,%VPTP,%P 1:PTP, 2:pt3, 3:C_PTP, 5:50, 7:PDAT12
$BWDSTART=FALSE
PDAT_ACT=PPDAT12
FDAT_ACT=Fpt3
BAS(#PTP_PARAMS,50)
PTP Xpt3 C_PTP
;ENDFOLD
        POSITION = 4
      CASE 4
        ;FOLD PTP pt4 CONT Vel=50 % PDAT13 Tool[4]:Pneumatic_gripper Base[0];%{PE}%R 5.6.11,%MKUKATPBASIS,%CMOVE,%VPTP,%P 1:PTP, 2:pt4, 3:C_PTP, 5:50, 7:PDAT13
$BWDSTART=FALSE
PDAT_ACT=PPDAT13
FDAT_ACT=Fpt4
BAS(#PTP_PARAMS,50)
PTP Xpt4 C_PTP
;ENDFOLD
        POSITION = 1
      ENDSWITCH
    ELSE

;FOLD PTP pt9 Vel=50 % PDAT17 Tool[1]:flange_adapter Base[0];%{PE}%R 5.6.11,%MKUKATPBASIS,%CMOVE,%VPTP,%P 1:PTP, 2:pt9, 3:, 5:50, 7:PDAT17
$BWDSTART=FALSE
PDAT_ACT=PPDAT17
FDAT_ACT=Fpt9
BAS(#PTP_PARAMS,50)
PTP Xpt9 
;ENDFOLD
    ENDIF
  ENDFOR
  

  $OUT[1] = FALSE
ENDIF

; move back to button
;FOLD PTP GBB_hover Vel=100 % PDAT9 Tool[4]:Pneumatic_gripper Base[0];%{PE}%R 5.6.11,%MKUKATPBASIS,%CMOVE,%VPTP,%P 1:PTP, 2:GBB_hover, 3:, 5:100, 7:PDAT9
$BWDSTART=FALSE
PDAT_ACT=PPDAT9
FDAT_ACT=FGBB_hover
BAS(#PTP_PARAMS,100)
PTP XGBB_hover 
;ENDFOLD

;FOLD LIN GBB Vel=0.5 m/s CPDAT1 Tool[4]:Pneumatic_gripper Base[0];%{PE}%R 5.6.11,%MKUKATPBASIS,%CMOVE,%VLIN,%P 1:LIN, 2:GBB, 3:, 5:0.5, 7:CPDAT1
$BWDSTART=FALSE
LDAT_ACT=LCPDAT1
FDAT_ACT=FGBB
BAS(#CP_PARAMS,0.5)
LIN XGBB 
;ENDFOLD

HALT

;FOLD PTP GBB_hover Vel=100 % PDAT2 Tool[4]:Pneumatic_gripper Base[0];%{PE}%R 5.6.11,%MKUKATPBASIS,%CMOVE,%VPTP,%P 1:PTP, 2:GBB_hover, 3:, 5:100, 7:PDAT2
$BWDSTART=FALSE
PDAT_ACT=PPDAT2
FDAT_ACT=FGBB_hover
BAS(#PTP_PARAMS,100)
PTP XGBB_hover 
;ENDFOLD

END